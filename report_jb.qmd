---
title: "EV Power - Lab 4 Project Report"
format: typst
---

# Example Solution 1

## **Part 0: libraries**

```{r}
library(tidyverse)
library(stringr)
```

## **Part 1:** **Defining Research Question**

# Chosen Question: What is the geographic distribution of the share of renewable energy in the United States? Is there a correlation between the share of renewable energy used and the price of renewable energy across states?

## **Part 2: Data Preparation and Cleaning**

```{r}
# getting working directory
getwd()

# listing files in current working directory
list.files()

# setting new working directory
setwd("/Users/jacobbjurstrom/ev-power-JacobBjurstrom/data")

# loading data for renewable energy use between 2021 - 2023
renew_use_21 <- read.csv("renew-use-2021.csv")
renew_use_22 <- read.csv("renew-use-2022.csv")
renew_use_23 <- read.csv("renew-use-2023.csv")

# loading data for total energy use between 2021 - 2023
tot_use_21 <- read.csv("total-use-2021.csv")
tot_use_22 <- read.csv("total-use-2022.csv")
tot_use_23 <- read.csv("total-use-2023.csv")

# loading data for average energy prices and ev-registrations
av_en_price_21_23 <- read.csv("av-energy-price-2021-2023.csv", header = FALSE)
ev_regis <- read.csv("ev-registrations-by-state-2023.csv")

## Better understanding structure of each dataset
str(renew_use_21)
str(renew_use_22)
str(renew_use_23)
head(renew_use_21)
head(renew_use_22)
head(renew_use_23)


str(tot_use_21)
str(tot_use_22)
str(tot_use_23)
head(tot_use_21)  # We will pivot longer these df
head(tot_use_22)  # We will pivot longer these df
head(tot_use_23)  # We will pivot longer these df

str(ev_regis)
head(ev_regis)
str(av_en_price_21_23)
head(av_en_price_21_23)


## Starting to clean each dataset

## Renewable energy usage datasets
# We have to standardize the values in the column "Renewable_Use_2021"
renew_use_21u <- renew_use_21 %>% mutate(renewable_use_21 = str_extract(Renewable_Use_2021, "[0-9]+"))

# repeating the same process for 2022 and 2023
renew_use_22u <- renew_use_22 %>% mutate(renewable_use_22 = str_extract(Renewable_Use_2022, "[0-9]+"))

renew_use_23u <- renew_use_23 %>% mutate(renewable_use_23 = str_extract(Renewable_Use_2023, "[0-9]+"), State = str_to_upper(State))

# Cleaning EV registrations by state dataframe

# Renaming columns and deleting first 2 rows
colnames(ev_regis)
head(ev_regis)
ev_regis_u <- ev_regis %>% rename(ev_registration_state = electric.vehicle.registrations_by_state..2023., ev_count = X) %>% slice(-c(1, 2))

# Only extracting ev registrations values
ev_regis_by_state <- ev_regis_u %>% mutate(ev_count_u = str_extract(ev_count, "[0-9]+"))


## Cleaning average energy price dataframe
colnames(av_en_price_21_23)

# removing first two rows
av_price <- av_en_price_21_23 %>% slice(-c(1:2))

# separating each column
colnames(av_price)
av_price_u <- av_price %>% separate(V1, into = c("State", "2021", "2022", "2023"), sep = ",") %>% slice(-c(1))

# Only extracting relevant variables for the column data
av_priceu <- av_price_u %>% mutate(two_one = str_extract(`2021`, "[0-9]+\\.[0-9]+"), two_two = str_extract(`2022`, "[0-9]+\\.[0-9]+"), two_three = str_extract(`2023`, "[0-9]+\\.[0-9]+")) %>% select(-c(2, 3, 4))
```

## **Part 3: Joining / Pivoting Datasets for Analysis**

```{r}
## Joining the renewable energy usage datasets
head(renew_use_21u)

# using a left join to join 2021 and 2022 data
df_21_22 <- left_join(x=renew_use_21u, y=renew_use_22u, by = join_by(State == State, Energy_Source == Energy_Source)) %>% select(-c("Renewable_Use_2021", "Renewable_Use_2022"))

# using another left join to join df_21_22 and 2023 data
df_21_23 <- left_join(x=df_21_22, y=renew_use_23u, by = join_by(State == State, Energy_Source == Energy_Source)) %>% select(-c("Renewable_Use_2023"))

## Calculating the total number of renewable energy used by state for each respective year
tot_ren_state <- df_21_23 %>%
  mutate(across(starts_with("renewable_use"), as.numeric)) %>%
  group_by(State) %>%
  summarize(
    total_21 = sum(renewable_use_21, na.rm = TRUE),
    total_22 = sum(renewable_use_22, na.rm = TRUE),
    total_23 = sum(renewable_use_23, na.rm = TRUE)
  )

## Pivoting the total energy usage dataframes
tot_use_21l <- tot_use_21 %>% pivot_longer(cols = -Energy_Source, names_to = "State", values_to = "Tot_usage_21") %>% group_by(State) %>% arrange(State)

## Repeating the same process for 2022 and 2023
tot_use_22l <- tot_use_22 %>% pivot_longer(cols = -Energy_Source, names_to = "State", values_to = "Tot_usage_22") %>% group_by(State) %>% arrange(State)

tot_use_23l <- tot_use_23 %>% pivot_longer(cols = -Energy_Source, names_to = "State", values_to = "Tot_usage_23") %>% group_by(State) %>% arrange(State)
```

## **Part 4: Mapping Visualization**

```{r}
# loading packages
library(maps)

# creating maps
us_map <- map_data("state") 

ggplot(us_map, aes(long, lat)) + geom_polygon(color = "white") + coord_fixed(1.3) + theme_minimal() + labs(title = "Average Income by State")


```